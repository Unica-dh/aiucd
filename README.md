# WordPress Docker Compose Setup

> üöÄ **Ambiente WordPress professionale con Docker Compose** - Deploy automatico, permessi corretti, upload fino a 100MB

## üìã Requisiti del Progetto

### Obiettivo

Realizzare un sito WordPress completo utilizzando Docker Compose per lo sviluppo e la produzione, con configurazione semplificata e ottimizzata.

### ‚úÖ Stato del Progetto

- ‚úÖ **Deploy automatico** via GitHub Actions
- ‚úÖ **Permessi corretti** con user mapping
- ‚úÖ **REST API funzionanti** con .htaccess configurato
- ‚úÖ **Upload file fino a 100MB**
- ‚úÖ **Pubblicazione contenuti** senza errori FTP
- ‚úÖ **Scripts di manutenzione** per diagnostica e fix

### Specifiche Tecniche

#### üîß Configurazione di Base

**Porta di esposizione**: `7000` (HTTP)
**Database**: MariaDB 10.11.5
**Web Server**: Apache (integrato nel container WordPress)
**PHP**: Versione stabile con configurazione ottimizzata (upload 100MB)
**Gestione SSL**: Non necessaria (gestita lato server)
**Upload Limit**: 100MB per file

#### üê≥ Servizi Docker

1. **WordPress** (`wordpress:6.8.3-apache`)
   - Container principale con WordPress + Apache + PHP
   - Esposto sulla porta 7000
   - User mapping per permessi corretti (UID/GID host)
   - Configurazione PHP: upload 100MB, memory 256MB
   - Volumi persistenti per files e uploads (bind mount)

2. **Database** (`mariadb:10.11.5`)
   - Database MariaDB per WordPress
   - Volumi persistenti per i dati (named volume)
   - Rete interna (non esposta esternamente)

3. **phpMyAdmin** (`phpmyadmin:5.2.1`)
   - Interfaccia web per gestione database
   - Esposto sulla porta 8080 per amministrazione

#### üìÅ Struttura Directory

```text
/home/ale/docker/aiucd/
‚îú‚îÄ‚îÄ README.md                   # Questa guida
‚îú‚îÄ‚îÄ docker-compose.yml          # Configurazione Docker completa
‚îú‚îÄ‚îÄ .env                        # Variabili d'ambiente (non versionato)
‚îú‚îÄ‚îÄ .env.example               # Template variabili d'ambiente
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml         # Deploy automatico CI/CD
‚îú‚îÄ‚îÄ wordpress/                 # Volume dati WordPress (bind mount)
‚îÇ   ‚îú‚îÄ‚îÄ .htaccess             # Configurazione Apache (rewrite rules)
‚îÇ   ‚îú‚îÄ‚îÄ wp-config.php         # Configurazione WordPress
‚îÇ   ‚îî‚îÄ‚îÄ wp-content/
‚îÇ       ‚îú‚îÄ‚îÄ uploads/          # Upload files (fino a 100MB)
‚îÇ       ‚îú‚îÄ‚îÄ themes/           # Temi WordPress
‚îÇ       ‚îî‚îÄ‚îÄ plugins/          # Plugin WordPress
‚îú‚îÄ‚îÄ php-config/
‚îÇ   ‚îî‚îÄ‚îÄ uploads.ini           # Configurazione PHP (upload 100MB)
‚îú‚îÄ‚îÄ scripts/                  # Scripts di utility
‚îÇ   ‚îú‚îÄ‚îÄ diagnose-permissions.sh      # Diagnostica permessi
‚îÇ   ‚îú‚îÄ‚îÄ fix-permissions.sh           # Fix automatico permessi
‚îÇ   ‚îú‚îÄ‚îÄ diagnose-rest-api.sh         # Test REST API
‚îÇ   ‚îú‚îÄ‚îÄ fix-rest-api.sh              # Fix REST API (.htaccess)
‚îÇ   ‚îú‚îÄ‚îÄ increase-upload-limit.sh     # Aumenta limite upload
‚îÇ   ‚îú‚îÄ‚îÄ migrate-uploads-to-bind-mount.sh  # Migrazione uploads
‚îÇ   ‚îî‚îÄ‚îÄ README.md                    # Documentazione scripts
‚îî‚îÄ‚îÄ doc/                      # Documentazione tecnica
    ‚îú‚îÄ‚îÄ FIX_SUMMARY.md              # Riepilogo fix applicati
    ‚îú‚îÄ‚îÄ PROBLEMA_RISOLTO.md         # Problemi risolti
    ‚îú‚îÄ‚îÄ QUICK_FIX_REST_API.md       # Quick fix REST API
    ‚îú‚îÄ‚îÄ UPLOAD_LIMIT_INCREASED.md   # Documentazione upload limit
    ‚îî‚îÄ‚îÄ ...                         # Altri documenti tecnici
```

#### üîê Configurazione Sicurezza

- **Credenziali database**: Gestite tramite file `.env`
- **WordPress secrets**: Chiavi di sicurezza generate automaticamente
- **Accesso database**: Solo rete interna Docker
- **File sensibili**: `.env` escluso dal versioning
- **User mapping**: Container gira con UID/GID utente host (no root)
- **Permessi file**: 644 per file, 755 per directory (no 777)
- **Upload security**: Limite 100MB, tipi file controllati da WordPress

#### üåê Accesso Applicazione

- **WordPress**: `http://localhost:7000`
- **phpMyAdmin**: `http://localhost:8080` (se abilitato)
- **Database**: Accessibile solo internamente tra container

## üìã Requisiti Sistema

### Software Richiesti

- **Docker**: versione 20.10+
- **Docker Compose**: versione 2.0+
- **Sistema Operativo**: Linux (testato), macOS, Windows con WSL2

### Risorse Hardware Minime

- **RAM**: 1GB libera
- **Storage**: 2GB liberi per volumi Docker
- **CPU**: 1 core (2+ raccomandati)

## üöÄ Funzionalit√†

### Core Features Implementate

- ‚úÖ **WordPress 6.8.3** con Apache
- ‚úÖ **Database MariaDB 10.11.5** con persistenza
- ‚úÖ **Deploy automatico** via GitHub Actions
- ‚úÖ **User mapping** per permessi corretti
- ‚úÖ **REST API** configurate e funzionanti
- ‚úÖ **Upload fino a 100MB** per file
- ‚úÖ **phpMyAdmin 5.2.1** per gestione database
- ‚úÖ **Backup automatici** database pre-deploy
- ‚úÖ **Health checks** nel workflow CI/CD
- ‚úÖ **Configurazione via environment** (.env)
- ‚úÖ **Rete isolata** per sicurezza
- ‚úÖ **Scripts di diagnostica** e fix automatici

### Configurazioni Ottimizzate

- üì¶ **PHP Upload**: 100MB max file size
- üíæ **PHP Memory**: 256MB per WordPress
- ‚è±Ô∏è **Execution Time**: 300 secondi (5 minuti)
- üîÑ **mod_rewrite**: Abilitato per permalink
- üîê **FS_METHOD**: Direct (no FTP)

### Features Escluse

- ‚ùå **Gestione SSL/HTTPS** (gestita lato server)
- ‚ùå **Reverse proxy Nginx** (non necessario)
- ‚ùå **Load balancing** (single instance)
- ‚ùå **Redis cache** (pu√≤ essere aggiunto se necessario)

## üéØ Casi d'Uso

### Sviluppo Locale

- Ambiente WordPress completo per sviluppo temi/plugin
- Database isolato per test
- Reset rapido dell'ambiente

### Staging/Produzione

- Deploy rapido su server
- Configurazione consistente tra ambienti
- Backup e restore semplificati

### Prototipazione

- Setup veloce per demo e test
- Configurazione minimal ma completa
- Facile personalizzazione

## üõ†Ô∏è Troubleshooting

### Problema: Errore "La risposta non √® una risposta JSON valida"

**Soluzione rapida**:
```bash
./scripts/fix-rest-api.sh
```

Poi vai in WordPress Admin ‚Üí Impostazioni ‚Üí Permalink ‚Üí Salva modifiche.

**Dettagli**: Vedi `doc/QUICK_FIX_REST_API.md`

---

### Problema: Upload file fallisce

**Soluzione**:
```bash
./scripts/fix-permissions.sh
```

Se il limite di 2MB √® troppo basso:
```bash
./scripts/increase-upload-limit.sh
```

---

### Problema: Permission denied durante deploy

**Causa**: UID/GID non configurato nel `.env`

**Soluzione**:
```bash
# Sul server di produzione
echo "DOCKER_UID=$(id -u)" >> .env
echo "DOCKER_GID=$(id -g)" >> .env
docker compose down
docker compose up -d
```

---

### Problema: Container non si avvia

```bash
# Controlla i log
docker compose logs wordpress
docker compose logs db

# Verifica configurazione
docker compose config

# Riavvia pulito
docker compose down
docker compose up -d
```

---

### Problema: Database connection error

```bash
# Verifica che il database sia pronto
docker compose exec db mysql -u wordpress -p

# Controlla variabili ambiente
docker compose exec wordpress env | grep WORDPRESS_DB

# Ricrea database
docker compose down
docker compose up -d db
# Attendi 10 secondi
docker compose up -d wordpress
```

---

## üìö Documentazione Dettagliata

La directory `doc/` contiene guide approfondite:

- **`FIX_SUMMARY.md`** - Riepilogo di tutti i fix applicati
- **`PROBLEMA_RISOLTO.md`** - Storico problemi risolti
- **`QUICK_FIX_REST_API.md`** - Quick reference REST API
- **`UPLOAD_LIMIT_INCREASED.md`** - Come funziona l'upload 100MB
- **`PERMISSION_ANALYSIS.md`** - Analisi tecnica permessi
- **`PRODUCTION_FIX_GUIDE.md`** - Guida produzione
- **`GITHUB_ACTIONS_SETUP.md`** - Setup CI/CD
- **`QUICKSTART_GITHUB_ACTIONS.md`** - Quick start deploy

---

## üèóÔ∏è Architettura del Sistema

### User Mapping Strategy

Il container WordPress gira con lo stesso UID/GID dell'utente host:

```yaml
# docker-compose.yml
services:
  wordpress:
    user: "${DOCKER_UID:-1000}:${DOCKER_GID:-1000}"
    environment:
      APACHE_RUN_USER: "#${DOCKER_UID:-1000}"
      APACHE_RUN_GROUP: "#${DOCKER_GID:-1000}"
```

**Benefici**:
- ‚úÖ File creati dal container hanno ownership corretta
- ‚úÖ Git pu√≤ modificare file senza permission denied
- ‚úÖ WordPress pu√≤ scrivere file senza FTP
- ‚úÖ Deploy GitHub Actions funziona senza sudo
- ‚úÖ Nessun bisogno di permessi 777 pericolosi

### Volume Strategy

**Bind Mount** per codice versionabile:

```yaml
volumes:
  - ./wordpress:/var/www/html
```

**Named Volume** solo per database:

```yaml
volumes:
  - db_data:/var/lib/mysql
```

**Configurazione PHP** via read-only mount:

```yaml
volumes:
  - ./php-config/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro
```

### Network Isolation

```yaml
networks:
  aiucd_network:
    driver: bridge
```

- Database accessibile solo da container WordPress
- Nessuna porta database esposta all'host
- phpMyAdmin pu√≤ accedere al database via network interno

## üéì Best Practices Implementate

### Sicurezza

- ‚úÖ Container non-root (user mapping)
- ‚úÖ Database non esposto esternamente
- ‚úÖ Secrets in file .env (non versionato)
- ‚úÖ Permessi file minimali (no 777)
- ‚úÖ Configurazione PHP hardened

### Performance

- ‚úÖ PHP memory limit ottimizzato (256MB)
- ‚úÖ Execution time adeguato (300s)
- ‚úÖ Upload ottimizzato (100MB)
- ‚úÖ Volumi persistenti per evitare rebuild

### Manutenibilit√†

- ‚úÖ Scripts automatizzati per fix comuni
- ‚úÖ Documentazione completa
- ‚úÖ Logs accessibili
- ‚úÖ Health checks nel CI/CD
- ‚úÖ Backup automatici

### DevOps

- ‚úÖ Infrastructure as Code (docker-compose.yml)
- ‚úÖ CI/CD con GitHub Actions
- ‚úÖ Deploy automatico
- ‚úÖ Rollback capabilities (via Git)
- ‚úÖ Environment parity (dev = prod)

---

## üéØ Configurazione Completa .env

Esempio di file `.env` completo per produzione:

```bash
# Docker User Mapping (IMPORTANTE!)
DOCKER_UID=1001
DOCKER_GID=1001

# WordPress Database Configuration
WORDPRESS_DB_NAME=wordpress
WORDPRESS_DB_USER=wpuser
WORDPRESS_DB_PASSWORD=change_this_secure_password

# MySQL Root Password
MYSQL_ROOT_PASSWORD=change_this_root_password

# WordPress URL (opzionale, default: http://localhost:7000)
WORDPRESS_URL=https://tuo-dominio.it

# WordPress Security Keys (genera qui: https://api.wordpress.org/secret-key/1.1/salt/)
WORDPRESS_AUTH_KEY='genera-chiave-sicura-qui'
WORDPRESS_SECURE_AUTH_KEY='genera-chiave-sicura-qui'
WORDPRESS_LOGGED_IN_KEY='genera-chiave-sicura-qui'
WORDPRESS_NONCE_KEY='genera-chiave-sicura-qui'
WORDPRESS_AUTH_SALT='genera-chiave-sicura-qui'
WORDPRESS_SECURE_AUTH_SALT='genera-chiave-sicura-qui'
WORDPRESS_LOGGED_IN_SALT='genera-chiave-sicura-qui'
WORDPRESS_NONCE_SALT='genera-chiave-sicura-qui'

# WordPress Extra Configuration
WORDPRESS_CONFIG_EXTRA="
define('WP_DEBUG', false);
define('WP_DEBUG_LOG', false);
define('WP_DEBUG_DISPLAY', false);
define('DISALLOW_FILE_EDIT', true);
define('FS_METHOD', 'direct');
define('WP_MEMORY_LIMIT', '256M');
define('WP_MAX_MEMORY_LIMIT', '256M');
"
```

---

## üìä Checklist Pre-Produzione

Prima di andare in produzione, verifica:

- [ ] File `.env` configurato con valori sicuri
- [ ] UID/GID configurato correttamente (`DOCKER_UID`, `DOCKER_GID`)
- [ ] Chiavi WordPress generate e inserite
- [ ] Password database sicure (no default)
- [ ] GitHub Secrets configurati per deploy automatico
- [ ] SSL configurato sul server (a monte di Docker)
- [ ] Backup automatici attivi
- [ ] Monitoring configurato (opzionale)
- [ ] Test deploy funzionante
- [ ] Test REST API: `curl http://tuo-dominio/wp-json/`
- [ ] Test upload file in WordPress
- [ ] Permalink salvati (Impostazioni ‚Üí Permalink)

---

## üöÄ Prossimi Sviluppi

Possibili miglioramenti futuri:

- üîÑ **Redis cache** per migliorare performance
- üìß **Email SMTP** configurazione
- üîç **Elasticsearch** per search avanzata
- üìà **Monitoring** con Prometheus/Grafana
- üîê **2FA** per login WordPress
- üåç **CDN integration** per assets statici
- ü§ñ **Automated testing** con Playwright
- üì± **Mobile app** integrazione

---

## ü§ù Contribuire

Per contribuire al progetto:

1. Fork del repository
2. Crea feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit modifiche (`git commit -m 'Add some AmazingFeature'`)
4. Push al branch (`git push origin feature/AmazingFeature`)
5. Apri Pull Request

---

## üìù Changelog

### v1.0.0 - 17 Ottobre 2025

**Features**:

- ‚úÖ Setup completo WordPress + MariaDB + phpMyAdmin
- ‚úÖ Deploy automatico via GitHub Actions
- ‚úÖ User mapping per permessi corretti
- ‚úÖ REST API configurate e funzionanti
- ‚úÖ Upload file fino a 100MB
- ‚úÖ Scripts di diagnostica e fix
- ‚úÖ Documentazione completa

**Bug Fixes**:

- üêõ Fix permission denied durante deploy
- üêõ Fix REST API "not valid JSON response"
- üêõ Fix upload file directory creation error
- üêõ Fix GitHub Actions workflow syntax error

---

## üìû Supporto

Per problemi o domande:

1. Consulta la documentazione in `doc/`
2. Esegui script di diagnostica appropriato
3. Controlla i logs: `docker compose logs`
4. Cerca nel README nella sezione Troubleshooting

---

## üìÑ Licenza

Questo progetto √® distribuito con licenza MIT. Vedi file `LICENSE` per dettagli.

---

## üôè Ringraziamenti

- WordPress Team per l'eccellente CMS
- Docker Team per la containerizzazione
- MariaDB Team per il database performante
- Community open source per supporto e feedback

---

**üéâ Il tuo ambiente WordPress Docker √® pronto per la produzione!**

---

## üìû Quick Start

### Prima Installazione

```bash
# 1. Clone o naviga nella directory
cd /home/ale/docker/aiucd

# 2. Copia e configura le variabili d'ambiente
cp .env.example .env

# 3. IMPORTANTE: Configura UID/GID per permessi corretti
echo "DOCKER_UID=$(id -u)" >> .env
echo "DOCKER_GID=$(id -g)" >> .env

# 4. Genera chiavi di sicurezza WordPress
# Visita: https://api.wordpress.org/secret-key/1.1/salt/
# Copia le chiavi generate nel file .env

# 5. Configura credenziali database nel .env:
nano .env  # Modifica WORDPRESS_DB_PASSWORD, MYSQL_ROOT_PASSWORD

# 6. Avvia i servizi
docker compose up -d

# 7. Attendi qualche secondo e verifica
docker compose ps

# 8. Accedi a WordPress
# http://localhost:7000
```

### Primo Accesso WordPress

1. Vai su `http://localhost:7000`
2. Completa l'installazione guidata
3. **Importante**: Vai in `Impostazioni ‚Üí Permalink` e clicca **Salva modifiche** (Questo genera il file .htaccess per REST API)
4. Tutto pronto! üéâ

### Deploy su Produzione con GitHub Actions

Il progetto include deploy automatico:

```bash
# 1. Configura .env sul server di produzione (vedi sopra)

# 2. Configura GitHub Secrets nel repository:
# - SERVER_HOST: IP o hostname del server
# - SERVER_USER: username SSH
# - SERVER_SSH_KEY: chiave privata SSH
# - SERVER_PATH: path al progetto sul server

# 3. Commit e push per deployare
git add .
git commit -m "Deploy to production"
git push origin main

# 4. Il workflow GitHub Actions far√† automaticamente:
# - Backup database
# - Deploy nuovo codice
# - Riavvio container
# - Health check
```

## üîß Comandi Utili

### Gestione Container

```bash
# Visualizza status servizi
docker compose ps

# Visualizza logs (tutti i servizi)
docker compose logs -f

# Visualizza logs WordPress
docker compose logs -f wordpress

# Visualizza logs database
docker compose logs -f db

# Riavvia un servizio specifico
docker compose restart wordpress

# Ferma i servizi
docker compose down

# Reset completo (‚ö†Ô∏è ATTENZIONE: cancella tutti i dati!)
docker compose down -v
```

### Scripts di Diagnostica

```bash
# Diagnostica permessi file
./scripts/diagnose-permissions.sh

# Fix automatico permessi
./scripts/fix-permissions.sh

# Diagnostica REST API
./scripts/diagnose-rest-api.sh

# Fix REST API (.htaccess + mod_rewrite)
./scripts/fix-rest-api.sh

# Aumenta limite upload a 100MB
./scripts/increase-upload-limit.sh

# Migra uploads da named volume a bind mount
./scripts/migrate-uploads-to-bind-mount.sh
```

### Verifica Configurazione

```bash
# Verifica settings PHP
docker compose exec wordpress php -i | grep -E "upload_max_filesize|post_max_size|memory_limit"

# Test REST API
curl -I http://localhost:7000/wp-json/

# Verifica permessi directory
docker compose exec wordpress ls -la /var/www/html/wp-content/uploads

# Verifica .htaccess
docker compose exec wordpress cat /var/www/html/.htaccess
```

### Backup e Restore

```bash
# Backup database manuale
docker compose exec db mysqldump -u wordpress -p wordpress > backup.sql

# Restore database
docker compose exec -T db mysql -u wordpress -p wordpress < backup.sql

# Backup file WordPress
tar czf wordpress-backup.tar.gz ./wordpress/

# Backup completo (database + file)
./scripts/backup-all.sh  # Se disponibile
```

---

*Last updated: 17 Ottobre 2025*
